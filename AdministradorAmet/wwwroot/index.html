<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AdministradorAmet</title>
    <base href="/" />
    <link rel="stylesheet" href="css/bootstrap/bootstrap.min.css" />
    <link rel="stylesheet" href="css/app.css" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <link href="AdministradorAmet.styles.css" rel="stylesheet" />
    <link rel="stylesheet" href="_content/Radzen.Blazor/css/material-base.css" />
    <link href="_content/MudBlazor/MudBlazor.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
    <link href="styles.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="_content/Blazored.Modal/blazored-modal.css" />

    
</head>

<body>
    <div id="app">
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">üóô</a>
    </div>


    <script>
        window.GenerarPDF = async (tickets) => {
            const token = localStorage.getItem('authToken');
            const getUsernameFromToken = (token) => {
                try {
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const payload = JSON.parse(atob(base64));
                    return payload['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name'] || 'Administrador';
                } catch {
                    return 'Administrador';
                }
            };
            const username = token ? getUsernameFromToken(token) : 'Administrador';
            const doc = new jsPDF();
            const img = new Image();
            img.src = "logo.png";
            img.crossOrigin = "";

            img.onload = () => {
                const pageHeight = doc.internal.pageSize.height;
                const marginTop = 20;
                const footerHeight = 20;
                const rowHeight = 10;
                const usableHeight = pageHeight - marginTop - footerHeight;

                const drawHeader = () => {
                    doc.setFont("times", "bold");
                    doc.setFontSize(16);
                    doc.addImage(img, 'PNG', 20, 10, 40, 40);
                    doc.text(75, 25, "Sistema de Gesti√≥n de Multas de Tr√°nsito");
                    const title = "Reporte de Multas";
                    const titleWidth = doc.getTextDimensions(title).w;
                    doc.text(75 + ((doc.internal.pageSize.width - 75 - titleWidth) / 2) + 23, 35, title);
                    doc.line(60, 40, doc.internal.pageSize.width - 20, 40);
                    doc.setFontSize(12);
                    doc.setFont("times", "bold");
                    doc.text(20, 55, "Nombre Completo");
                    doc.text(60, 55, "C√©dula");
                    doc.text(90, 55, "Fecha");
                    doc.text(115, 55, "Multa");
                    doc.text(135, 55, "Estado");
                    doc.text(155, 55, "Infracci√≥n");
                    doc.text(180, 55, "N¬∞ Agente");
                    return 65; // start row data below headers
                };

                const drawFooter = () => {
                    const today = new Date();
                    const dateTime =
                        `Fecha: ${today.getDate().toString().padStart(2, '0')}/` +
                        `${(today.getMonth() + 1).toString().padStart(2, '0')}/` +
                        `${today.getFullYear()} Hora: ` +
                        `${today.getHours().toString().padStart(2, '0')}:` +
                        `${today.getMinutes().toString().padStart(2, '0')}`;

                    doc.setFontSize(12);
                    doc.setFont("times", "normal");
                    doc.text(20, pageHeight - 10, `Elaborado por: ${username}`);
                    doc.text(140, pageHeight - 10, dateTime);
                };

                let rowY = drawHeader();
                doc.setFont("times", "normal");

                tickets.forEach((ticket, index) => {
                    // Check if we need a new page *before* drawing the next row
                    if (rowY + rowHeight > pageHeight - footerHeight) {
                        drawFooter(); // draw footer on current page
                        doc.addPage();
                        rowY = drawHeader();
                        doc.setFont("times", "normal");
                    }

                    const status = ticket.Status === "Paid" ? "Pagada" :
                        ticket.Status === "pending" ? "Pendiente" :
                            ticket.Status;

                    doc.text(20, rowY, `${ticket.Name} ${ticket.LastName}`);
                    doc.text(60, rowY, ticket.Identification);
                    doc.text(90, rowY, ticket.TicketDate);
                    doc.text(120, rowY, ticket.TicketId.toString());
                    doc.text(135, rowY, status);
                    doc.text(155, rowY, ticket.Articulo);
                    doc.text(185, rowY, ticket.AgentNumber.toString());
                    rowY += rowHeight;
                });

                drawFooter(); // footer on last page
                const blob = doc.output('blob');
                saveAs(blob, 'Reporte.pdf');
            };

            img.onerror = () => {
                console.error("Error cargando el logo.");
            };
        };




    </script>






    <script>
        window.GenerarPDFfinanciero = async (tickets, fechaInicio, fechaFin) => {
            console.log("GenerarPDF function called");

            // Obtener el token desde localStorage usando la clave correcta 'authToken'
            const token = localStorage.getItem('authToken');
            console.log("Token recuperado:", token);  // Verifica si el token existe

            // Funci√≥n para obtener el nombre desde el token
            const getUsernameFromToken = (token) => {
                try {
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const payload = JSON.parse(atob(base64));

                    console.log('Token decodificado correctamente:', payload);  // Verifica la decodificaci√≥n

                    return payload['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name'] || 'Administrador';
                } catch (error) {
                    console.error('Error decodificando el token:', error);  // Error en la decodificaci√≥n
                    return 'Administrador'; // Valor por defecto si hay error
                }
            };

            // Usar el token recuperado para obtener el nombre
            const username = token ? getUsernameFromToken(token) : 'Administrador';
            console.log("Usuario obtenido:", username);  // Verifica el nombre del usuario

            var doc = new jsPDF();
            console.log("jsPDF instance created");

            // Establecer fuente
            doc.setFont("times", "bold");

            // IMAGEN
            var img = new Image();
            img.src = "logo.png";
            img.crossOrigin = "";
            img.onload = function () {
                console.log("Image loaded");

                // Agregar imagen al lado izquierdo
                const imgX = 20;
                const imgY = 10;
                doc.addImage(this, 'PNG', imgX, imgY, 40, 40);

                // Contenido en el lado derecho del encabezado
                doc.setFontSize(16);
                const contentX = 75;

                // Texto "Sistema de Gesti√≥n de Multas de Tr√°nsito"
                const systemTextY = 25;
                doc.text(contentX, systemTextY, "Sistema de Gesti√≥n de Multas de Tr√°nsito");

                // T√≠tulo "Reporte Financiero" ajustado hacia la derecha
                const reportTextY = systemTextY + 10;
                const title = "Reporte Financiero";
                const titleWidth = doc.getTextDimensions(title).w;

                const titleOffsetX = 23;
                const titleX = contentX + ((doc.internal.pageSize.width - contentX) - titleWidth) / 2 + titleOffsetX;
                doc.text(titleX, reportTextY, title);

                // Agregar las fechas seleccionadas debajo del t√≠tulo
                const fechasY = reportTextY + 10; // Ajustar la posici√≥n vertical de las fechas
                doc.setFont("times", "normal");
                doc.setFontSize(12);
                const fechasX = contentX + 20; // Ajustar este valor para mover las fechas horizontalmente
                doc.text(fechasX, fechasY, `Del ${fechaInicio} al ${fechaFin}`); // Posicionamiento horizontal de las fechas

                // T√≠tulos de columnas
                const lineY = fechasY + 10; // Ajustamos lineY para que las fechas no se sobrepongan con las columnas
                const startY = lineY + 15; // Ajustar este valor para subir la tabla m√°s arriba
                doc.setFontSize(12);
                doc.setFont("times", "bold"); // Encabezados en negrita
                let rowY = startY;

                // Configuraci√≥n de columnas
                const columns = {
                    numMulta: 10,
                    fecha: 40,
                    cedula: 65,
                    estado: 95,
                    pagadas: 135,
                    pendientes: 165
                };

                // Encabezados
                doc.text(columns.numMulta, rowY, "No. Multa");
                doc.text(columns.fecha, rowY, "Fecha");
                doc.text(columns.cedula, rowY, "C√©dula");
                doc.text(columns.estado, rowY, "Estado");
                doc.text(columns.pagadas, rowY, "Pagadas");
                doc.text(columns.pendientes, rowY, "Pendientes");

                // Datos de la tabla
                rowY += 10;
                doc.setFont("times", "normal");

                const formatter = new Intl.NumberFormat('es-DO', {
                    style: 'currency',
                    currency: 'DOP'
                });

                let totalPagadas = 0;
                let totalPendientes = 0;

                tickets.forEach((ticket) => {
                    const status = ticket.status === "Paid" ? "Pagada" :
                        ticket.status === "pending" ? "Pendiente" :
                            ticket.status;

                    // Formatear valores
                    const fecha = new Date(ticket.ticketDate).toLocaleDateString('es-DO');
                    const montoPagado = status === "Pagada" ? formatter.format(ticket.articulo.price) : "";
                    const montoPendiente = status === "Pendiente" ? formatter.format(ticket.articulo.price) : "";

                    // Acumular totales
                    if (status === "Pagada") totalPagadas += ticket.articulo.price;
                    if (status === "Pendiente") totalPendientes += ticket.articulo.price;

                    // Agregar fila
                    doc.text(columns.numMulta, rowY, ticket.ticketId.toString());
                    doc.text(columns.fecha, rowY, fecha);
                    doc.text(columns.cedula, rowY, ticket.identification);
                    doc.text(columns.estado, rowY, status);
                    doc.text(columns.pagadas, rowY, montoPagado);
                    doc.text(columns.pendientes, rowY, montoPendiente);

                    rowY += 10;
                });

                // L√≠nea divisora antes de los totales
                const lineStartX = 15; // Definir lineStartX
                const lineEndX = 195; // Definir lineEndX
                rowY += 5; // Espacio antes de la l√≠nea divisora
                doc.setLineWidth(0.5);
                doc.line(lineStartX, rowY, lineEndX, rowY);
                rowY += 5; // Espacio despu√©s de la l√≠nea divisora

                // Totales
                doc.setFont("times", "bold");
                doc.text(columns.estado - 10, rowY, "Total:");
                doc.text(columns.pagadas, rowY, formatter.format(totalPagadas));
                doc.text(columns.pendientes, rowY, formatter.format(totalPendientes));

                // PIE DE P√ÅGINA
                var today = new Date();
                var dateTime =
                    "Fecha: " +
                    today.getDate().toString().padStart(2, '0') + '/' +
                    (today.getMonth() + 1).toString().padStart(2, '0') + '/' +
                    today.getFullYear() + ' Hora: ' +
                    today.getHours().toString().padStart(2, '0') + ':' +
                    today.getMinutes().toString().padStart(2, '0');

                doc.setFontSize(12);
                doc.text(20, 290, `Elaborado por: ${username}`);
                doc.text(140, 290, dateTime);

                // Generar el PDF
                var blob = doc.output('blob');
                saveAs(blob, 'ReporteMultas.pdf');
                console.log("PDF saved");
            };

            img.onerror = function () {
                console.error("Failed to load image");
            };
        };




    </script>

    <script type="text/javascript">
        function Print() {
            var divcontent = document.getElementById("resultadoreporte").innerHTML;
            var a = window.open('', 'Reporte', 'height=1300,width=1300');
            a.document.write('<html>');
            a.document.write('<body><br/>');
            a.document.write(divcontent);
            a.document.write('<body></html>')
            a.document.close();
            a.print();
        }

    </script>


    <script type="text/javascript">
        function PrintMulta() {
            var divcontent = document.getElementById("resultadomulta").innerHTML;
            var a = window.open('', 'Reporte', 'height=1300,width=1300');
            a.document.write('<html>');
            a.document.write('<body><br/>');
            a.document.write(divcontent);
            a.document.write('<body></html>')
            a.document.close();
            a.print();
        }


    </script>

    <script>
        window.generatemultaPDF = async (elementId, ticketId) => {
            const element = document.querySelector(elementId);

            // Ocultar botones antes de generar PDF
            const buttons = element.querySelectorAll('button');
            buttons.forEach(btn => btn.style.display = 'none');
            const span = element.querySelector('span');
            if (span) {
                span.style.display = 'none'; // Ocultar el <span>
            }

            // Crear una nueva instancia de jsPDF
            const pdf = new jspdf.jsPDF('p', 'mm', 'a4');

            // Usar la funci√≥n 'html' de jsPDF para agregar contenido HTML al PDF
            pdf.html(element, {
                callback: function (pdf) {
                    // Restaurar botones despu√©s de generar el PDF
                    buttons.forEach(btn => btn.style.display = 'block');

                    // Guardar el PDF con el nombre din√°mico que incluye el ticketId
                    pdf.save(`Multa No.-${ticketId}.pdf`);

                    window.location.reload();
                },
                x: 35,
                y: 10,
                width: 140, // Ajustar el ancho
                windowWidth: 650 // Establecer el tama√±o de la ventana para asegurar la conversi√≥n correcta
            });
        };


    </script>




    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- Aseg√∫rate de cargar primero la librer√≠a html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.js"></script>


    <!-- Scripts adicionales que ya tienes -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.0.272/jspdf.debug.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script src="_content/Radzen.Blazor/Radzen.Blazor.js"></script>
    <script src="_framework/blazor.webassembly.js"></script>
    <script src="_content/MudBlazor/MudBlazor.min.js"></script>
    <script src="print.js"></script>
    <script src="js/site.js"></script>

    <script src="jquery/jquery.min.js"></script>




</body>
</html>