@inject NavigationManager NavigationManager
@inject HttpClient Http
@using AdministradorAmet.Models
@using Newtonsoft.Json
<PageTitle>Perfil del Agente</PageTitle>
@page "/perfilAgente/{cedula}"

<!-- Fuentes -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500&display=swap" rel="stylesheet">

<h1 class="title">Perfil del Agente</h1>

<!-- Mostrar los datos del agente -->
@if (usuario != null)
{
    <div class="main-container">
        <!-- Columna izquierda (70%) -->
        <div class="left-column">
            <div class="container large-container">
                <div class="icons">
                    <img src="imagenes/edit-icon.svg" alt="Editar" class="icon" title="Editar">
                    <img src="imagenes/exportar.png" alt="Notas" class="icon" title="Exportar">
                    <img src="imagenes/delete-icon.svg" alt="Eliminar" class="icon" title="Eliminar">
                </div>
                <div class="agent-info">
                    <div class="photo-section">
                        <!-- Foto de Perfil basada en el género del usuario -->
                        <img src="@((usuario.Gender.ToLower() == "masculino") ? "imagenes/usuario.png" : "imagenes/femenina.png")"
                             alt="Foto de Perfil" class="profile-photo" />
                        <h3>@usuario.FullName</h3>
                        <p class="id">No. Agente: @usuario.NoAgente</p>
                    </div>

                    <div class="details-section">
                        <div class="column">
                            <p><strong>Cédula:</strong> @usuario.Cedula</p>
                            <p><strong>Email:</strong> @usuario.email</p>
                            <p><strong>Teléfono:</strong> @usuario.Phone</p>
                            <p><strong>Género:</strong> @usuario.Gender</p>
                            <p><strong>Ubicación de Trabajo:</strong> @usuario.workLocation</p>
                        </div>
                        <div class="column">
                            <p><strong>Tipo de Sangre:</strong> @usuario.bloodType</p>
                            <p><strong>Estado Civil:</strong> @usuario.civilStatus</p>
                            <p><strong>Fecha de Nacimiento:</strong> @usuario.birthdate</p>
                            <p><strong>Altura:</strong> @usuario.height</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container">
                <h3>Últimas Reseñas</h3>
                @if (reseñas != null && reseñas.Count > 0)
                {
                    @for (int i = 0; i < 3; i++)
                    {
                        if (i < reseñas.Count)
                        {
                            <div class="review">
                                <p><strong>Comentario:</strong> @reseñas[i].Comment</p>
                                <p><strong>Rating:</strong> @reseñas[i].Rating</p>
                                <p><strong>Fecha:</strong> @reseñas[i].CreatedAt.ToString("dd/MM/yyyy")</p>
                            </div>
                        }
                        else
                        {
                            <div class="review">
                                <p><strong>Comentario:</strong> Sin comentarios</p>
                            </div>
                        }
                    }
                }
                else
                {
                    <p>No hay comentarios disponibles para este agente.</p>
                }
            </div>
        </div>

        <!-- Columna derecha (30%) -->
        <div class="right-column">
            <div class="container">
                <h3>Porcentaje de Multas</h3>
                <div class="progress-bar">
                    <div class="progress" style="width: 80%;"></div>
                </div>
                <span>80%</span>
            </div>

            <div class="container">
                <h3>Promedio de Calificaciones</h3>
                <div class="rating-bar">
                    <div class="progress" style="width: 85%;"></div>
                </div>
                <span>4.25 / 5</span>
            </div>

            <div class="container">
                <h3>Multas por Artículo</h3>
                <img src="imagenes/grafico.png" alt="Gráfico de Multas" class="chart" />
            </div>
        </div>
    </div>
}
else
{
    <p>Cargando datos del usuario...</p>
}

@code {
    [Parameter]
    public string Cedula { get; set; }

    private User usuario;
    private List<Review> reseñas = new List<Review>();

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(Cedula))
        {
            try
            {
                // Obtener los datos del usuario
                usuario = await Http.GetFromJsonAsync<User>($"https://localhost:7277/api/User/{Cedula}");

                // Obtener las reseñas para el agente
                var response = await Http.GetStringAsync($"https://localhost:7277/api/Reviews/GetLatestReviewsForAgentByCedula/{Cedula}");
                var reviewsResponse = JsonConvert.DeserializeObject<ReviewsResponse>(response);

                // Si el objeto response no es null y tiene reseñas
                if (reviewsResponse?.Reviews != null && reviewsResponse.Reviews.Count > 0)
                {
                    reseñas = reviewsResponse.Reviews;
                }
                else
                {
                    reseñas = new List<Review>(); // No hay reseñas
                }
            }
            catch (HttpRequestException ex)
            {
                Console.WriteLine($"Error al obtener reseñas: {ex.Message}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error inesperado: {ex.Message}");
            }
        }
    }

    public class Review
    {
        public int Rating { get; set; }
        public string Comment { get; set; }
        public DateTime CreatedAt { get; set; }
    }

    public class ReviewsResponse
    {
        public List<Review> Reviews { get; set; }
    }
}
